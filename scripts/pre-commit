#!/bin/bash
#
# Pre-commit hook for drive-sync
# Runs tests before allowing commits
#
# Install:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Get the root of the git repo
ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

# Run tests in Docker (preferred) or locally
echo ""
echo "=== Running Tests ==="

if command -v docker &> /dev/null && docker info &> /dev/null; then
    # Docker available - run tests in container
    echo "Running tests in Docker..."
    docker run --rm drive-sync-drive-sync python -m pytest tests/ -v --tb=short
else
    # Fallback to local pytest
    echo "Docker not available, running tests locally..."
    if ! command -v pytest &> /dev/null; then
        echo "Warning: pytest not found, skipping tests"
        echo "Install with: pip install pytest"
        exit 0
    fi
    python -m pytest tests/ -v --tb=short
fi

# Check for syntax errors in Python files being committed
echo ""
echo "=== Checking Python Syntax ==="
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [[ -n "$STAGED_PY_FILES" ]]; then
    for file in $STAGED_PY_FILES; do
        python -m py_compile "$file" || {
            echo "Syntax error in $file"
            exit 1
        }
    done
    echo "All Python files have valid syntax"
else
    echo "No Python files staged"
fi

echo ""
echo "=== Pre-commit checks passed ==="
